#!/bin/sh

set -e
test X$1 = X && echo 'Usage: wp-new SITE_NAME' && exit 1 ||

## Manual configuration

VHOST_DIR=/var/vhosts
VHOST_CONF_DIR=/etc/nginx/sites-enabled
GIT_REFERENCE='--reference /store/media/dxw/reference/wordpress'

## Automatic configuration

VHOST_CONF=$VHOST_CONF_DIR/$1
HOST=$1.`hostname`

##

# Clone WordPress

mkdir -p $VHOST_DIR/$1/logs
git clone $GIT_REFERENCE git://github.com/dxw/wordpress.git $VHOST_DIR/$1/docs || true

cd $VHOST_DIR/$1/docs && git checkout `git tag | tail -n1` && cd -

# Configure

F=$VHOST_DIR/$1/docs/wp-config.php

cat << EOF >> $F
<?php

#function wp_check_password(){return true;}

#define('WP_DEBUG', true);
#define('SCRIPT_DEBUG', true);
#define('STYLE_DEBUG', true);

#define('WP_ALLOW_MULTISITE', true);

define('DB_NAME', '$1');
define('DB_USER', 'root');
define('DB_PASSWORD', '');
define('DB_HOST', 'localhost');
define('DB_CHARSET', 'utf8');
define('DB_COLLATE', '');
define('WP_HOME', 'http://$HOST' );
define('WP_SITEURL', 'http://$HOST');
\$table_prefix  = 'wp_';
define ('WPLANG', '');
if ( !defined('ABSPATH') )
  define('ABSPATH', dirname(__FILE__) . '/');
require_once(ABSPATH . 'wp-settings.php');
if (!empty(\$_SERVER['HTTP_X_FORWARDED_PROTO']) &&
  \$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') \$_SERVER['HTTPS'] = '1';
if (!empty(\$_SERVER['HTTP_X_FORWARDED_FOR'])) \$_SERVER['REMOTE_ADDR'] = trim(array_shift(explode(',', \$_SERVER['HTTP_X_FORWARDED_FOR'])));
EOF

# Add vhost

echo 127.0.0.1 $HOST | sudo tee -a /etc/hosts

cat << EOF | sudo tee $VHOST_CONF
server {
  listen   [::]:80;
  server_name $1.ayumu;
  root $VHOST_DIR/$1/docs;

  include common/wordpress.conf;
}
EOF

# Create database

echo "create database if not exists $1" | mysql

# Restart

sudo service nginx configtest
sudo service nginx restart
